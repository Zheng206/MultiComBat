% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/data_prep.R
\name{model_fitting}
\alias{model_fitting}
\title{Fit a per-defined model with batch effects}
\usage{
model_fitting(data, batch, covar, model, formula = NULL, ...)
}
\arguments{
\item{data}{A numeric matrix or data frame of responses with observations in rows
and features (e.g., ROIs, genes) in columns. Each column is modeled separately.}

\item{batch}{A factor (recommended) or vector coercible to factor giving the batch
label for each observation (length must match \code{nrow(data)}).}

\item{covar}{Optional data frame (or list/data.frame-coercible object)
of covariates with \code{nrow(covar) == nrow(data)}. If \code{NULL}, a null
model (intercept only) is fitted and a warning is issued.}

\item{model}{A modeling function (e.g., \code{\link[stats]{lm}},
\code{\link[lme4]{lmer}}, \code{mgcv::gam}). Must accept a
\code{formula} and \code{data} argument.}

\item{formula}{A right-hand-side formula for the covariate part of the model
(excluding batch). For example, \code{y ~ age + sex}. If \code{covar} is
provided and \code{formula} is \code{NULL}, the function stops with an error.
When \code{covar} is \code{NULL}, a null model \code{y ~ 1} is used.}

\item{...}{Additional arguments passed on to \code{model}.}
}
\value{
A list with components:
\describe{
\item{data}{The input \code{data}.}
\item{mod}{The constructed data frame of predictors (covariates and batch).}
\item{formula}{The base formula used before adding batch terms.}
\item{fits}{A named list (one per column of \code{data}) of fitted model objects.}
}
}
\description{
Fits the user-specified model to each column of \code{data}, augmenting the
model with batch indicators (no intercept) and optional covariates.
}
\section{Warnings/Errors}{

\itemize{
\item If \code{covar} is \code{NULL}, a null model is used and a warning is issued.
\item If \code{covar} is provided but \code{formula} is \code{NULL}, the function errors.
\item \code{batch} is expected to be a valid factor aligning with \code{nrow(data)}.
}
}

\examples{
set.seed(1)
n <- 50; p <- 5
Y <- matrix(rnorm(n * p), n, p, dimnames = list(NULL, paste0("feat", 1:p)))
bat <- factor(sample(c("siteA", "siteB", "siteC"), n, TRUE))

# Null model (no covariates)
fit0 <- model_fitting(Y, batch = bat, covar = NULL, model = lm)
names(fit0$fits)
summary(fit0$fits[[1]])

# With covariates and a formula
covars <- data.frame(age = rnorm(n, 60, 10), sex = factor(sample(c("F","M"), n, TRUE)))
out <- batch_matrix(bat, ref.batch = "siteA")
fit1 <- model_fitting(
  data   = Y,
  batch  = out$batch_matrix,
  covar  = covars,
  model  = lm,
  formula = y ~ age + sex
)
coef(fit1$fits[[1]])

}
