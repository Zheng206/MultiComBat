% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/data_prep.R
\name{standardize_data}
\alias{standardize_data}
\title{Standardize features by removing fitted batch/covariate means and pooling variance}
\usage{
standardize_data(model, batch_result, robust.LS = FALSE)
}
\arguments{
\item{model}{A list returned by \code{\link{model_fitting}} containing
\code{$data}, \code{$mod}, \code{$formula}, and \code{$fits}.}

\item{batch_result}{A list returned by \code{\link{batch_matrix}} containing
\code{$batch_vector}, \code{$n_batches}, and optionally \code{$ref}.}

\item{robust.LS}{Logical; if \code{TRUE}, use a robust scale estimator
(\code{biweight_midvar}) for the pooled variance; otherwise use \code{\link[stats]{var}}.}
}
\value{
A list with components:
\describe{
\item{data_stand}{An \eqn{n \times p} matrix of standardized values.}
\item{stand_mean}{An \eqn{n \times p} matrix of standardization means used in the numerator.}
\item{sd_mat}{An \eqn{n \times p} matrix of per-feature pooled standard deviations.}
}
}
\description{
Uses fitted models (from \code{model_fitting()}) and batch metadata (from
\code{batch_matrix()}) to compute per-feature standardized values:
\deqn{Z = (Y - \hat{\mu}_{\mathrm{stand}}) / \hat{\sigma}}.
The standardization mean \eqn{\hat{\mu}_{\mathrm{stand}}} is obtained by predicting
from the fitted models under either (i) a mixture batch profile given by batch
proportions (default), or (ii) a designated reference batch if provided.
Variance is pooled across observations (optionally using a robust scale).
}
\examples{
set.seed(1)
n <- 80; p <- 6
Y <- matrix(rnorm(n * p, sd = 2), n, p,
            dimnames = list(NULL, paste0("feat", 1:p)))
bat <- factor(sample(c("A","B","C"), n, TRUE, prob = c(.4,.4,.2)))
X   <- data.frame(age = rnorm(n, 60, 8),
                  sex = factor(sample(c("F","M"), n, TRUE)))

# Build batch helpers and fit per-feature models
bres <- batch_matrix(bat)
mf   <- model_fitting(
  data    = Y,
  batch   = bres$batch_matrix,
  covar   = X,
  model   = lm,
  formula = y ~ age + sex
)

# Standardize using mixture-of-batches mean and pooled variance
out1 <- standardize_data(mf, bres, robust.LS = FALSE)
dim(out1$data_stand); colMeans(out1$stand_mean)

}
