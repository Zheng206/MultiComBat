% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/harmonization.R
\name{com_harm}
\alias{com_harm}
\title{ComBat harmonization (univariate)}
\usage{
com_harm(
  bat,
  data,
  covar,
  model = lm,
  formula = NULL,
  ref.batch = NULL,
  eb = TRUE,
  stan = FALSE,
  robust.LS = FALSE,
  cov = FALSE,
  var_thresh = 0.95,
  min_rblock = 1,
  max_rblock = Inf,
  ...
)
}
\arguments{
\item{bat}{Factor (or coercible) of length \code{n} giving batch labels.}

\item{data}{Numeric \eqn{n \times G} matrix/data frame of features (columns must be named).}

\item{covar}{\code{NULL} or an \eqn{n \times q} data frame of covariates. If \code{NULL},
a null model \code{y ~ 1} is used (warning issued).}

\item{model}{Modeling function that accepts \code{formula} and \code{data}
(e.g., \code{stats::lm}, \code{stats::glm}, \code{mgcv::gam}). Default \code{lm}.}

\item{formula}{RHS formula for covariates (excluding batch), e.g., \code{y ~ age + sex}.
Required when \code{covar} is not \code{NULL}.}

\item{ref.batch}{Optional reference batch level. Predictions for standardization
are taken under this batch; final output replaces those rows with the original values.}

\item{eb}{Logical; if \code{TRUE} (default) perform EB shrinkage of batch means/variances.}

\item{stan}{Logical; if \code{TRUE}, use the full Bayesian (Stan) routine
(\code{stan_data_prep()}, \code{stan_algorithm()}) instead of EB.}

\item{robust.LS}{Logical; if \code{TRUE}, use robust scale estimators
(\code{\link{biweight_midvar}}) in standardization/dispersion.}

\item{cov}{Logical; if \code{TRUE}, apply an additional CovBat-style covariance
harmonization in PCA score space after ComBat mean/variance adjustment (default \code{FALSE}).}

\item{var_thresh}{Numeric in (0,1]; cumulative explained-variance threshold used
to choose how many PC scores are harmonized when \code{cov = TRUE}
(passed to \code{\link{pick_r_from_pc}}; default \code{0.95}).}

\item{min_rblock}{Integer; minimum number of PC scores to harmonize when \code{cov = TRUE}
(default \code{1}).}

\item{max_rblock}{Integer; maximum number of PC scores to harmonize when \code{cov = TRUE}
(default \code{Inf}).}

\item{...}{Additional arguments forwarded to \code{model}.}
}
\value{
A list with:
\describe{
\item{harm_data}{\eqn{n \times G} harmonized matrix on the original scale.}
\item{resid}{Standardized, batch-adjusted residuals (\eqn{n \times G}).}
\item{eb_result}{(when \code{stan = FALSE}) EB outputs: \code{gamma_star}, \code{delta_star},
and pre-EB summaries.}
\item{stan_result}{(when \code{stan = TRUE}) Output of \code{stan_algorithm()}, typically
including posterior summaries for \code{gamma_star}/\code{delta_star}
and MCMC diagnostics.}
}
}
\description{
End-to-end \emph{univariate} ComBat-style harmonization for an
\eqn{n \times G} matrix (rows = samples, columns = features), with optional
empirical Bayes (EB) shrinkage and robust scale estimation. A \emph{fully
Bayesian (Stan)} variant is also available via \code{stan = TRUE}.
}
\section{Full Bayesian (Stan) variant}{

With \code{stan = TRUE}, the batch parameters \eqn{\gamma} (means) and
\eqn{\delta} (variances) are inferred from their joint posterior using MCMC.
Internally, \code{stan_data_prep()} builds the data list and
\code{stan_algorithm()} runs Stan and returns posterior summaries used for
harmonization (e.g., posterior means of \code{gamma_star} and
\code{delta_star}).
}

\examples{
set.seed(1)
n <- 30; G <- 5
Y <- matrix(rnorm(n*G, sd = 2), n, G, dimnames = list(NULL, paste0("feat", 1:G)))
bat <- factor(sample(c("A","B","C"), n, TRUE))
X   <- data.frame(age = rnorm(n, 60, 8))
out <- com_harm(bat = bat, data = Y, covar = X, model = stats::lm,
                formula = y ~ age, ref.batch = "A", eb = TRUE)
str(out$harm_data)

}
